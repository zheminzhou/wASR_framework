# NNPred

NNPred is a set of Python scripts for phylogenetic trait prediction using nearest neighbor approaches and random forest classification. It processes genomic data in the form of SNP matrices and phylogenetic trees to predict traits for nodes in the tree. The package includes two main scripts: `NNPred_train.py` for training a model and generating ROC curves, and `NNPred_query.py` for training a random forest classifier and making predictions.

## Prerequisites

To use NNPred, you need the following dependencies installed:

- Python 3.6+
- Required Python packages:
  - `ete3_extensions` (custom extension for ETE3 toolkit)
  - `pandas`
  - `numpy`
  - `click`
  - `matplotlib`
  - `scikit-learn`
  - `multiprocess`

You can install the required packages using pip:

```bash
pip install pandas numpy click matplotlib scikit-learn multiprocess
```

**Note**: The `ete3_extensions` module is a custom dependency and must be provided separately or implemented as per your phylogenetic data processing needs.

## Installation

1. Clone the repository:

```bash
git clone https://github.com/zheminzhou/wASR_framework.git
cd wASR_framework/NNPred
```

2. Ensure all dependencies are installed as mentioned above.

3. Place the `NNPred_train.py` and `NNPred_query.py` scripts in your working directory.

## Usage

### NNPred_train.py

This script trains a nearest neighbor-based model for phylogenetic trait prediction and generates ROC curves for evaluation.

**Command-line options**:

- `-r, --reference`: Path to the reference file (required).
- `-n, --nexus`: Path to the nexus file from EPHI (required).
- `-m, --matrix`: Path to the reconstructed ancestral states matrix by ETOKI (required).
- `-w, --weight`: Path to the weight file (optional, default: None).
- `-p, --prefix`: Prefix for output model files (required).
- `-N, --n_neighbor`: Number of closest neighbors to consider (default: 1).

**Example**:

```bash
python NNPred_train.py -r reference.fasta -n tree.nexus -m snp_matrix.txt.gz -w weights.txt -p output_model -N 5
```

**Output**:
- A pickled model file: `<prefix>.model.pickle`
- ROC curves plot: `<prefix>.roc_curves.pdf`
- ROC curve data: `<prefix>.roc_curves.list`

### NNPred_query.py

This script trains a random forest classifier for trait prediction using a nearest neighbor-based feature extraction approach.

**Command-line options**:

- `-n, --nexus`: Path to the nexus file from EPHI (required).
- `-m, --matrix`: Path to the reconstructed ancestral states matrix by ETOKI (required).
- `-w, --weight`: Path to the weight file (optional, default: None).
- `-p, --prefix`: Prefix for output model files (required).
- `-l, --leaf_only`: Flag to process only leaf nodes (optional, default: False).

**Example**:

```bash
python NNPred_query.py -n tree.nexus -m snp_matrix.txt.gz -w weights.txt -p output_model -l
```

**Output**:
- A pickled model file: `<prefix>.model.pickle` containing the trained random forest classifier, parameters, and scores.

## Input File Formats

- **Nexus file**: A phylogenetic tree file in Nexus format, typically generated by EPHI, containing node annotations with traits.
- **Matrix file**: A gzipped tab-separated file containing SNP data with ancestral states reconstructed by ETOKI. The first two columns are site information, followed by columns for each node.
- **Weight file**: A tab-separated file with two columns: trait name and weight (optional).
- **Reference file** (for `NNPred_train.py`): A reference sequence file used for prediction.

## Workflow

1. **NNPred_train.py**:
   - Reads the nexus file to extract node traits and weights.
   - Processes the SNP matrix to encode nucleotide data.
   - Splits data into training, validation, and testing sets for cross-validation.
   - Uses a nearest neighbor approach to compute trait probabilities.
   - Generates ROC curves and saves them as a PDF and text file.
   - Saves the model and associated data in a pickle file.

2. **NNPred_query.py**:
   - Reads the nexus file and SNP matrix similarly.
   - Extracts features using a nearest neighbor approach.
   - Performs grid search over random forest hyperparameters to find the best model.
   - Trains a final random forest classifier and saves it in a pickle file.

## Notes

- The scripts use multiprocessing (`multiprocess.Pool`) to parallelize computations, with a default pool size of 10 processes.
- The `ete3_extensions` module is assumed to provide custom functionality for reading nexus files with annotations. Ensure this module is compatible with your data.
- The SNP matrix should be preprocessed to ensure valid nucleotide characters (A, C, G, T, -, .).
- For large datasets, adjust the `chunksize` parameter in the scripts if memory issues arise.

## Contributing

Contributions are welcome! Please submit a pull request or open an issue on GitHub for bug reports, feature requests, or improvements.
