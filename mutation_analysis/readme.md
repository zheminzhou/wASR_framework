\# DivHMM Genomic Analysis Pipeline



This repository contains a collection of Python scripts designed to analyze mutation hotspots in genomic data using a Diversifying Hidden Markov Model (DHMM). The scripts process genomic data to identify diversified and recombining regions, associate mutations with genes and geographic traits, and perform enrichment analyses. Below is a description of each script, its purpose, and how they work together as part of a cohesive pipeline.



\## Overview



The pipeline takes as input genomic data including mutation files, gene annotations, diversified and recombining region files, and phylogenetic trees. It processes these to:

\- Identify genes overlapping with mutation hotspots.

\- Associate mutations with geographic or temporal traits.

\- Perform enrichment analyses for genes and KEGG Orthology (KO) terms.

\- Compute similarities between geographic regions based on shared mutation hotspots.



The scripts are designed to be run sequentially or in combination, depending on the analysis goals. They use common input formats such as GFF files for gene annotations, mutation files in gzip format, and region files generated by a DHMM tool.



\## Scripts and Their Functions



\### 1. `DivHMM\_region\_annotation.py`

\*\*Purpose\*\*: Identifies genes overlapping with diversified regions and annotates them with mutation counts.



\*\*Functionality\*\*:

\- Reads diversified regions (`-d`, `\*.diversified.region`) and recombining regions (`-r`, `\*.recombination.region`) to identify genomic segments with high mutation rates.

\- Processes a GFF file (`-g`) to extract gene annotations and associate them with genomic positions.

\- Reads mutation data (`-m`, `\*.mutations.gz`) to count mutations (SNPs and indels) within diversified regions.

\- Assigns mutations to genes based on their genomic coordinates.

\- Outputs a file (`-o`) with annotations for each diversified region, including the contig, start/end positions, mutation counts (SNPs and indels), and associated genes.



\*\*Inputs\*\*:

\- `-d`/`--dhmm`: File containing diversified regions.

\- `-r`/`--rhmm`: File containing recombining regions.

\- `-m`/`--mutation`: Gzip-compressed mutation file.

\- `-g`/`--gff`: GFF file for gene annotations.

\- `-t`/`--gene\_tag`: Tag for gene identifiers in GFF (default: `locus\_tag`).

\- `-o`/`--outfile`: Output file (default: derived from input `dhmm` file with `.annotations` suffix).



\*\*Outputs\*\*:

\- A tab-delimited file listing diversified regions with mutation counts and associated genes.



\*\*Usage in Pipeline\*\*:

\- This script is typically the first step to annotate diversified regions with gene information.

\- Its output is used by downstream scripts like `DivHMM\_to\_genes\_KO\_enrichment.py` for further gene-based analyses.



---



\### 2. `DivHMM\_to\_genes.py`

\*\*Purpose\*\*: Extends `DivHMM\_region\_annotation.py` by associating genes with KEGG Orthology (KO) identifiers and categorizing mutations by region type (normal, diversified, or recombining).



\*\*Functionality\*\*:

\- Similar to `DivHMM\_region\_annotation.py`, it reads diversified (`-d`) and recombining (`-r`) regions, mutation data (`-m`), and GFF annotations (`-g`).

\- Incorporates a KO list (`-k`) to map genes to KEGG Orthology identifiers.

\- Categorizes mutations into normal, diversified (`inDiv`), or recombining (`inRec`) regions and assigns mutation types (e.g., synonymous, nonsynonymous, frameshift) to genes.

\- Outputs a file (`-o`) with gene details, including KO identifiers, genomic coordinates, strand, and mutation counts for each region type.



\*\*Inputs\*\*:

\- `-d`/`--dhmm`: Diversified regions file.

\- `-r`/`--rhmm`: Recombining regions file.

\- `-m`/`--mutation`: Gzip-compressed mutation file.

\- `-g`/`--gff`: GFF file for gene annotations.

\- `-t`/`--gene\_tag`: Tag for gene identifiers (default: `locus\_tag`).

\- `-k`/`--ko\_list`: File mapping genes to KO identifiers.

\- `-o`/`--outfile`: Output file (default: derived from `dhmm` file with `.related\_genes` suffix).



\*\*Outputs\*\*:

\- A tab-delimited file listing genes with their KO identifiers, genomic coordinates, and mutation counts in normal, diversified, and recombining regions.



\*\*Usage in Pipeline\*\*:

\- Builds on `DivHMM\_region\_annotation.py` by adding KO annotations.

\- Its output (`\*.related\_genes`) is used by `DivHMM\_to\_genes\_KO\_enrichment.py` and `DivHMM\_to\_trait\_gene\_enrichment.py` for enrichment analyses.



---



\### 3. `DivHMM\_to\_genes\_KO\_enrichment.py`

\*\*Purpose\*\*: Performs KEGG Orthology (KO) enrichment analysis for genes associated with diversified and recombining regions.



\*\*Functionality\*\*:

\- Reads the output from `DivHMM\_to\_genes.py` (`-d`, `\*.diversified.related\_genes`) to extract genes and their mutation profiles.

\- Uses a KEGG BRITE hierarchy file (`-k`, default: `/titan/softwares/RecHMM/ko00001.json`) to group genes by functional categories.

\- Performs Fisher’s exact test to identify KO categories enriched in diversified or recombining regions compared to a baseline (all genes).

\- Applies false discovery rate (FDR) correction to p-values.

\- Outputs enrichment results (`-o`), including mutation statistics and enriched KO categories with p-values and FDR-corrected q-values.



\*\*Inputs\*\*:

\- `-d`/`--dhmm\_genes`: Output file from `DivHMM\_to\_genes.py`.

\- `-k`/`--ko\_brite`: KEGG BRITE hierarchy file (JSON format).

\- `-o`/`--outfile`: Output file (default: derived from `dhmm\_genes` with `.enrichment` suffix).



\*\*Outputs\*\*:

\- A file containing mutation statistics (e.g., dN/dS, pseudogene ratios) and enriched KO categories with statistical significance.



\*\*Usage in Pipeline\*\*:

\- Takes the output of `DivHMM\_to\_genes.py` to perform functional enrichment analysis.

\- Results are useful for understanding the biological significance of mutation hotspots.



---



\### 4. `DivHMM\_to\_trait.py`

\*\*Purpose\*\*: Associates mutations in diversified and recombining regions with geographic or other traits using phylogenetic tree information.



\*\*Functionality\*\*:

\- Reads diversified (`-d`) and recombining (`-r`) regions, mutation data (`-m`), a phylogenetic tree (`-t`), and a treetime nexus file (`-n`) for temporal or trait annotations.

\- Maps mutations to branches of the phylogenetic tree and categorizes them by region type (normal, diversified, or recombining) and mutation type (e.g., synonymous, nonsynonymous).

\- Uses trait conversion dictionaries (`Bp\_conv`, `ParaA\_conv`, `TB\_conv`) to map sample locations to geographic regions.

\- Performs Fisher’s exact test to identify traits (e.g., geographic regions) enriched for mutations in diversified regions.

\- Outputs a CSV file (`-p`.trait\_mutations.csv) with mutation counts per trait and region, and an enrichment file (`-p`.trait\_mutations.enrichment) with statistically significant trait associations.



\*\*Inputs\*\*:

\- `-p`/`--prefix`: Prefix for output files.

\- `-n`/`--nexus`: Treetime nexus file with trait annotations.

\- `-R`/`--root\_node`: Root node for the tree (optional).

\- `-t`/`--tree`: Original phylogenetic tree file.

\- `-m`/`--mutations`: Gzip-compressed mutation file.

\- `-r`/`--rhmm`: Recombining regions file.

\- `-d`/`--dhmm`: Diversified regions file.

\- `-D`/`--direction`: Tree traversal direction (`up` or `down`, default: `down`).



\*\*Outputs\*\*:

\- `prefix.trait\_mutations.csv`: Mutation counts per trait and region.

\- `prefix.trait\_mutations.enrichment`: Enrichment results for traits with significant mutation associations.



\*\*Usage in Pipeline\*\*:

\- Analyzes mutation patterns in the context of phylogenetic traits (e.g., geographic origins).

\- Its enrichment output is used by `DivHMM\_to\_trait\_gene\_enrichment.py`.



---



\### 5. `DivHMM\_to\_trait\_gene\_enrichment.py`

\*\*Purpose\*\*: Identifies genes and KO terms associated with geographically enriched mutation hotspots.



\*\*Functionality\*\*:

\- Reads the enrichment output from `DivHMM\_to\_trait.py` (`-g`, `\*.trait\_mutations.enrichment`) to identify significantly enriched geographic regions.

\- Reads the gene annotations from `DivHMM\_to\_genes.py` (`-k`, `\*.related\_genes`) to map genes and KO terms to genomic coordinates.

\- Identifies genes overlapping with enriched diversified regions and associates them with geographic traits.

\- Outputs a file (`-p`.DHMM.geo\_gene.enrichment) listing genes, their KO identifiers, and associated geographic regions.



\*\*Inputs\*\*:

\- `-p`/`--prefix`: Prefix for output files.

\- `-g`/`--geo\_enrichment`: Enrichment file from `DivHMM\_to\_trait.py`.

\- `-k`/`--gene\_kos`: Gene annotations file from `DivHMM\_to\_genes.py`.



\*\*Outputs\*\*:

\- `prefix.DHMM.geo\_gene.enrichment`: Tab-delimited file listing genes, KO identifiers, and associated geographic regions.



\*\*Usage in Pipeline\*\*:

\- Links geographic enrichment results from `DivHMM\_to\_trait.py` with gene annotations from `DivHMM\_to\_genes.py`.

\- Provides a detailed mapping of genes to geographic mutation hotspots.



---



\### 6. `DivHMM\_to\_timed.py`

\*\*Purpose\*\*: Analyzes mutation rates in diversified and recombining regions over time using a timed phylogenetic tree.



\*\*Functionality\*\*:

\- Similar to `DivHMM\_to\_trait.py`, it reads diversified (`-d`), recombining (`-r`), mutation (`-m`), tree (`-t`), and nexus (`-n`) files.

\- Maps mutations to branches of a timed phylogenetic tree and categorizes them by region type and mutation type.

\- Aggregates mutation rates over time intervals (years) and computes confidence intervals for mutation rates in diversified and recombining regions relative to normal regions.

\- Outputs a CSV file (`-p`.timed\_mutations.csv) with mutation rates and confidence intervals for each time interval.



\*\*Inputs\*\*:

\- `-p`/`--prefix`: Prefix for output files.

\- `-n`/`--nexus`: Treetime nexus file with temporal annotations.

\- `-R`/`--root\_node`: Root node for the tree (optional).

\- `-t`/`--tree`: Original phylogenetic tree file.

\- `-m`/`--mutations`: Gzip-compressed mutation file.

\- `-r`/`--rhmm`: Recombining regions file.

\- `-d`/`--dhmm`: Diversified regions file.

\- `-D`/`--direction`: Tree traversal direction (`up` or `down`, default: `down`).



\*\*Outputs\*\*:

\- `prefix.timed\_mutations.csv`: Mutation rates and confidence intervals over time.



\*\*Usage in Pipeline\*\*:

\- Provides temporal analysis of mutation rates, complementing the geographic analysis in `DivHMM\_to\_trait.py`.

\- Can be used independently or alongside other scripts for evolutionary studies.



---



\### 7. `DivHMM\_to\_trait\_region\_network.py`

\*\*Purpose\*\*: Computes similarities between geographic regions based on shared mutation hotspots.



\*\*Functionality\*\*:

\- Reads the enrichment output from `DivHMM\_to\_trait.py` (`input\_file`) to identify significantly enriched regions (q-value < 0.01, %pos > %neg).

\- Calculates the proportion of shared diversified regions between pairs of geographic regions using a modified Jukes-Cantor distance.

\- Outputs a CSV file (`--output`) listing pairs of regions and their similarity scores, sorted by similarity.



\*\*Inputs\*\*:

\- `input\_file`: Enrichment file from `DivHMM\_to\_trait.py`.

\- `--output`/`-o`: Output CSV file (optional; prints to stdout if not provided).



\*\*Outputs\*\*:

\- A CSV file with columns `country1`, `country2`, and `similarity`, or output to stdout.



\*\*Usage in Pipeline\*\*:

\- Analyzes relationships between geographic regions based on shared mutation hotspots.

\- Complements `DivHMM\_to\_trait.py` by providing a network perspective on geographic associations.



---



\## Pipeline Workflow



The scripts are designed to work together in a modular pipeline. A typical workflow might proceed as follows:



1\. \*\*Annotate Diversified Regions with Genes\*\*:

&nbsp;  - Run `DivHMM\_region\_annotation.py` to associate diversified regions with genes and mutation counts.

&nbsp;  - Output: `\*.annotations`



2\. \*\*Add KO Annotations\*\*:

&nbsp;  - Run `DivHMM\_to\_genes.py` to extend annotations with KO identifiers and categorize mutations by region type.

&nbsp;  - Output: `\*.related\_genes`



3\. \*\*Perform KO Enrichment Analysis\*\*:

&nbsp;  - Run `DivHMM\_to\_genes\_KO\_enrichment.py` to identify enriched KO categories in diversified and recombining regions.

&nbsp;  - Input: Output from `DivHMM\_to\_genes.py`

&nbsp;  - Output: `\*.enrichment`



4\. \*\*Associate Mutations with Traits\*\*:

&nbsp;  - Run `DivHMM\_to\_trait.py` to associate mutations with geographic or other traits using phylogenetic data.

&nbsp;  - Output: `\*.trait\_mutations.csv` and `\*.trait\_mutations.enrichment`



5\. \*\*Map Genes to Enriched Geographic Regions\*\*:

&nbsp;  - Run `DivHMM\_to\_trait\_gene\_enrichment.py` to link genes and KO terms to geographically enriched regions.

&nbsp;  - Input: Outputs from `DivHMM\_to\_trait.py` and `DivHMM\_to\_genes.py`

&nbsp;  - Output: `\*.DHMM.geo\_gene.enrichment`



6\. \*\*Analyze Temporal Mutation Rates\*\*:

&nbsp;  - Run `DivHMM\_to\_timed.py` to analyze mutation rates over time (optional, if temporal analysis is needed).

&nbsp;  - Output: `\*.timed\_mutations.csv`



7\. \*\*Compute Geographic Region Similarities\*\*:

&nbsp;  - Run `DivHMM\_to\_trait\_region\_network.py` to calculate similarities between geographic regions based on shared mutation hotspots.

&nbsp;  - Input: Output from `DivHMM\_to\_trait.py`

&nbsp;  - Output: CSV file with similarity scores.



\## Dependencies



The scripts rely on the following Python packages:

\- `click`: For command-line interface.

\- `pandas`, `numpy`: For data manipulation and statistical analysis.

\- `scipy.stats`: For Fisher’s exact test and FDR correction.

\- `ete3`, `ete3\_extensions`: For phylogenetic tree processing.

\- `keggtools`: For KEGG Orthology enrichment analysis.

\- `statsmodels`: For multiple testing correction.

\- Standard libraries: `os`, `collections`, `gzip`, `re`, `json`.



Ensure these are installed using `pip`:

```bash

pip install click pandas numpy scipy ete3 matplotlib keggtools statsmodels

