# DHMM

DHMM (Divergent Hidden Markov Model) is a Python script for identifying diversified regions in genomic sequences using a Hidden Markov Model (HMM) approach. It is a much faster and easier-to-use reimplementation of the method published in:

Z. Zhou, A. McCann, F. Weill, C. Blin, S. Nair, J. Wain, G. Dougan, & M. Achtman, *Transient Darwinian selection in Salmonella enterica serovar Paratyphi A during 450 years of global spread of enteric fever*, Proc. Natl. Acad. Sci. U.S.A. 111 (33) 12199-12204, [https://doi.org/10.1073/pnas.1411012111](https://doi.org/10.1073/pnas.1411012111) (2014).

The script processes mutation data and sequence information to detect regions with high mutation or recombination rates, using a Baum-Welch algorithm for parameter estimation and Viterbi or marginal likelihood methods for prediction.

## Prerequisites

To use DHMM, you need the following dependencies installed:

- Python 3.6+
- Required Python packages:
  - `numpy`
  - `pandas`
  - `numba`
  - `json`
  - `argparse`

You can install the required packages using pip:

```bash
pip install numpy pandas numba
```

## Installation

1. Clone the repository:

```bash
git clone https://github.com/zheminzhou/wASR_framework.git
cd wASR_framework/DHMM
```

2. Ensure all dependencies are installed as mentioned above.

3. Place the `DHMM.py` script in your working directory.

## Usage

The `DHMM.py` script processes mutation data and optional recombination regions to fit an HMM model and predict diversified regions.

**Command-line options**:

- `--data, -d`: Path to the mutation data file (required, generated by EToKi phylo).
- `--rechmm, -r`: Path to imported regions generated by RecHMM (optional, recommended).
- `--model, -m`: Path to a saved best model file (optional, default: none).
- `--task, -t`: Task mode (0: one mutation category, 1: three mutation categories including mixed sources, default: 1).
- `--init, -i`: Initial guesses for proportions of divergent regions (default: `0.01,0.05,0.1`).
- `--prefix, -p`: Prefix for output files (default: `DivHMM`).
- `--cool_down, -c`: Delete the worst model every N iterations (default: 5).
- `--report, -R`: Only report the model without calculating external sketches (default: False).
- `--marginal, -M`: Use marginal likelihood for prediction (0 for Viterbi, (0,1] for marginal likelihood with threshold, default: 0).
- `--clean, -v`: Suppress intermediate output during iterations (default: False).

**Example**:

```bash
python DHMM.py -d mutations.txt.gz -r rechmm.txt -p output -t 1 -i 0.01,0.05,0.1 -c 5
```

**Output**:
- Model file: `<prefix>.div.model.json`
- Diversified regions: `<prefix>.diversified.region`
- Model report: `<prefix>.div.model.report`

## Input File Formats

- **Mutation data file** (gzipped, tab-separated):
  - Generated by EToKi phylo.
  - Contains mutation information with columns: branch, sequence name, position, weight, mutation type (e.g., `A->C`).
  - Header lines starting with `##` provide sequence lengths (`## Sequence_length: name length`) and missing regions (`## Missing_region: name start end`).

**Example**:
```
## Sequence_length: seq1 1000
## Missing_region: seq1 200 300
branch1 seq1 100 1 A->C
branch2 seq1 150 1 G->T
```

- **RecHMM file** (optional, tab-separated):
  - Contains recombination regions with columns: `Importation`, branch, sequence name, start, end.

**Example**:
```
Importation branch1 seq1 50 100
Importation branch1 seq2 200 250
```

## Workflow

1. **Data Parsing**:
   - Reads mutation data, sequence lengths, and missing regions from the input file.
   - Optionally incorporates recombination regions from a RecHMM file.
   - Prepares branch observations, accounting for missing regions and sequence anchors.

2. **Model Training**:
   - Initializes HMM models based on specified mutation categories and initial guesses for divergent region proportions.
   - Uses the Baum-Welch algorithm to optimize model parameters over a maximum of 200 iterations.
   - Saves the best model to a JSON file.

3. **Prediction**:
   - Predicts diversified regions using either the Viterbi algorithm (default) or marginal likelihood method.
   - Outputs detected regions with mutation rates, diversified rates, and coverage statistics.

4. **Reporting**:
   - Generates a report with model parameters (e.g., mutation rates, homoplasy rates) and bootstrap confidence intervals.

## Notes

- The script uses `numba` for performance optimization of critical functions like transition matrix updates.
- Multiprocessing is employed for parallel computation of branch measures.
- The `--marginal` option allows for more flexible region detection using posterior probabilities, with a threshold between 0 and 1.
- The model supports different modes for mutation categories (legacy, hybrid, intra, both), with `both` (mode 1) as the default.
- Output files are written in a structured format for easy downstream analysis.

## Contributing

Contributions are welcome! Please submit a pull request or open an issue on GitHub for bug reports, feature requests, or improvements.

## Citation

This script is a reimplementation of the method described in:

Z. Zhou, A. McCann, F. Weill, C. Blin, S. Nair, J. Wain, G. Dougan, & M. Achtman, *Transient Darwinian selection in Salmonella enterica serovar Paratyphi A during 450 years of global spread of enteric fever*, Proc. Natl. Acad. Sci. U.S.A. 111 (33) 12199-12204, [https://doi.org/10.1073/pnas.1411012111](https://doi.org/10.1073/pnas.1411012111) (2014).
